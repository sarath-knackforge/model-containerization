name: Containerize ML Model

on:
  repository_dispatch:
    types: [model_approved]

jobs:
  containerize:
    runs-on: ubuntu-latest
    environment: dev

    env:
      # ===== MODEL INFO (FROM DATABRICKS) =====
      MODEL_NAME: ${{ github.event.client_payload.model_name }}
      MODEL_VERSION: ${{ github.event.client_payload.model_version }}

      # ===== DATABRICKS AUTH (SERVICE PRINCIPAL) =====
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
      DATABRICKS_AUTH_TYPE: oauth
      MLFLOW_ENABLE_DB_SDK: "true"

      # ===== AWS / ECR =====
      AWS_REGION: ap-south-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPO: ml-models

    steps:
      - name: Debug MLflow env
        run: |
          echo "MLFLOW_ENABLE_DB_SDK=$MLFLOW_ENABLE_DB_SDK"
          echo "DATABRICKS_AUTH_TYPE=$DATABRICKS_AUTH_TYPE"

      # ------------------------------------------------
      # 1️⃣ Checkout code
      # ------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------
      # 2️⃣ Setup Python
      # ------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------
      # 3️⃣ Install Python dependencies
      # ------------------------------------------------
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install \
            mlflow==2.12.2 \
            databricks-sdk==0.36.0


      - name: Debug Databricks env
        run: |
          echo "HOST=$DATABRICKS_HOST"
          echo "AUTH_TYPE=$DATABRICKS_AUTH_TYPE"

      # ------------------------------------------------
      # 4️⃣ Download model from Databricks UC
      # ------------------------------------------------
      - name: Download model from Databricks
        run: python ci/download_model.py

      # ------------------------------------------------
      # 5️⃣ Login to AWS ECR
      # ------------------------------------------------
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ------------------------------------------------
      # 6️⃣ Build Docker image
      # ------------------------------------------------
      - name: Build Docker image
        run: |
          docker build \
            --build-arg MODEL_PATH=model \
            -t $ECR_REPO:$MODEL_VERSION \
            .

      # ------------------------------------------------
      # 7️⃣ Tag image
      # ------------------------------------------------
      - name: Tag Docker image
        run: |
          docker tag \
            $ECR_REPO:$MODEL_VERSION \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$MODEL_VERSION

      # ------------------------------------------------
      # 8️⃣ Push image to ECR
      # ------------------------------------------------
      - name: Push image to ECR
        run: |
          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$MODEL_VERSION

      # ------------------------------------------------
      # 9️⃣ Success log
      # ------------------------------------------------
      - name: Done
        run: echo "✅ Model $MODEL_NAME version $MODEL_VERSION pushed to ECR"
